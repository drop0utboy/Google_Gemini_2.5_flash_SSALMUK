<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spring AI - Gemini Chat Demo</title>
    <!-- Tailwind CSS ëŒ€ì‹ , ê¸°ì¡´ ì½”ë“œì—ì„œ ì‚¬ìš©í•œ Bootstrapì„ ìœ ì§€í•˜ë©° í•„ìš”í•œ ìŠ¤íƒ€ì¼ë§Œ ì¶”ê°€í•©ë‹ˆë‹¤. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- ì™¸ë¶€ íŒŒì¼ì´ì—ˆë˜ /css/springai.cssì˜ ë‚´ìš©ì„ ì—¬ê¸°ì— í†µí•©í•©ë‹ˆë‹¤. -->
    <style>
        /* ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ ì •ì˜ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }

        #headPanel {
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .user-message {
            background-color: #0d6efd; /* Primary blue for user */
            color: white;
            padding: 8px 12px;
            border-radius: 18px 18px 0 18px;
            max-width: 80%;
            margin-left: auto;
            margin-bottom: 10px;
        }

        .assistant-message {
            background-color: #e9ecef; /* Light gray for assistant */
            color: #343a40;
            padding: 10px 14px;
            border-radius: 18px 18px 18px 0;
            max-width: 80%;
            margin-right: auto;
            margin-bottom: 10px;
        }
    </style>

    <script>
        // ì™¸ë¶€ íŒŒì¼ì´ì—ˆë˜ /js/springai.jsì˜ ë‚´ìš©ì„ ì—¬ê¸°ì— í†µí•©í•©ë‹ˆë‹¤.
        const springai = {
            // 1. ì‚¬ìš©ì ì§ˆë¬¸ì„ ëŒ€í™” íŒ¨ë„ì— ì¶”ê°€
            addUserQuestion: function (question, containerId) {
                const chatPanel = document.getElementById(containerId);
                const userDiv = document.createElement('div');
                userDiv.className = 'd-flex justify-content-end p-2';
                userDiv.innerHTML = `
                    <div class="user-message">
                        ${question}
                    </div>
                `;
                chatPanel.appendChild(userDiv);
                document.getElementById("question").value = "";
                chatPanel.scrollTop = chatPanel.scrollHeight;
            },

            // 2. ì‘ë‹µ ëŒ€ê¸° ì‹œ ìŠ¤í”¼ë„ˆ í‘œì‹œ/ìˆ¨ê¹€
            setSpinner: function (spinnerId, visible) {
                const spinner = document.getElementById(spinnerId);
                if (visible) {
                    spinner.classList.remove('d-none');
                } else {
                    spinner.classList.add('d-none');
                }
            },

            // 3. ë‹µë³€ í…ìŠ¤íŠ¸ê°€ ë“¤ì–´ê°ˆ í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì¶”ê°€í•˜ê³  UUID ë°˜í™˜
            addAnswerPlaceHolder: function (containerId) {
                const uuid = 'msg-' + Date.now() + Math.random().toString(16).slice(2);
                const chatPanel = document.getElementById(containerId);

                const assistantDiv = document.createElement('div');
                assistantDiv.className = 'd-flex justify-content-start p-2';
                assistantDiv.innerHTML = `
                    <div class="assistant-message" id="${uuid}">
                        <span class="fw-bold text-success">ğŸ¤– Gemini: </span>
                        <span class="message-content"></span>
                    </div>
                `;
                chatPanel.appendChild(assistantDiv);
                chatPanel.scrollTop = chatPanel.scrollHeight;
                return uuid;
            },

            // 4. ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µì„ ë°›ì•„ì„œ í”Œë ˆì´ìŠ¤í™€ë”ì— ì¶œë ¥
            printAnswerText: async function (stream, uuid) {
                const placeholder = document.getElementById(uuid);
                const contentSpan = placeholder.querySelector('.message-content');

                if (!stream) {
                    contentSpan.textContent = "ì‘ë‹µ ìŠ¤íŠ¸ë¦¼ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
                    return;
                }

                // ìŠ¤íŠ¸ë¦¬ë° ë¦¬ë”ë¥¼ ì‚¬ìš©í•˜ì—¬ í…ìŠ¤íŠ¸ë¥¼ ë¹„ë™ê¸°ì ìœ¼ë¡œ ì½ì–´ì˜µë‹ˆë‹¤.
                const reader = stream.getReader();
                const decoder = new TextDecoder();
                let fullText = '';

                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        // ì‘ë‹µì€ ì¼ë°˜ í…ìŠ¤íŠ¸ì´ë¯€ë¡œ ë°”ë¡œ ë””ì½”ë”©í•˜ì—¬ ì¶”ê°€í•©ë‹ˆë‹¤.
                        const chunk = decoder.decode(value);
                        fullText += chunk;
                        contentSpan.textContent = fullText;
                        
                        // ìŠ¤í¬ë¡¤ì„ ìµœì‹  ë©”ì‹œì§€ë¡œ ì´ë™
                        const chatPanel = document.getElementById('chatPanel');
                        chatPanel.scrollTop = chatPanel.scrollHeight;
                    }
                } catch (error) {
                    console.error("Error reading stream:", error);
                    contentSpan.textContent += "\n\n[ìŠ¤íŠ¸ë¦¬ë° ì˜¤ë¥˜ ë°œìƒ]";
                }
            }
        };


        // ##### ì œì¶œ ë²„íŠ¼ì„ í´ë¦­í–ˆì„ ë•Œ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜ #####
        async function handleSubmit() {
            // í…ìŠ¤íŠ¸ ì§ˆë¬¸ì„ ì–»ê³  ëŒ€í™” íŒ¨ë„ì— ì¶”ê°€í•˜ê¸°
            const questionInput = document.getElementById("question");
            const question = questionInput.value.trim();
            if (question === "") return;

            springai.addUserQuestion(question, "chatPanel");

            try {
                // ì‘ë‹µì´ ì˜¤ê¸°ê¹Œì§€ ìŠ¤í”¼ë„ˆ ë³´ì—¬ì£¼ê¸°
                springai.setSpinner("spinner", true);
                
                // AI ëª¨ë¸ ë‹µë³€ì´ ë“¤ì–´ê°ˆ ìœ„ì¹˜ë¥¼ ëŒ€í™” íŒ¨ë„ì— ì¶”ê°€í•˜ê³  UUID ë°›ê¸°
                const uuid = springai.addAnswerPlaceHolder("chatPanel");

                // AJAX ìš”ì²­í•˜ê³  ì‘ë‹µë°›ê¸°
                // Spring ControllerëŠ” MediaType.TEXT_PLAIN_VALUEë¡œ ì‘ë‹µí•˜ë¯€ë¡œ, ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬í•©ë‹ˆë‹¤.
                const response = await fetch('/ai/chat', {
                    method: "post",
                    // Content-Type í—¤ë”ëŠ” ì„œë²„ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ consumesì™€ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'text/plain'
                    }, Â  Â  Â  Â  Â 
                    // bodyëŠ” URLSearchParamsë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ì½”ë”©
                    body: new URLSearchParams({ question })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    document.getElementById(uuid).querySelector('.message-content').textContent = 
                        `[ì˜¤ë¥˜ ë°œìƒ]: ${response.status} ${response.statusText}\n${errorText}`;
                    return;
                }

                // í…ìŠ¤íŠ¸ ë‹µë³€ì„ ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ ì¶œë ¥í•˜ê¸°
                // response.bodyëŠ” ReadableStreamì…ë‹ˆë‹¤.
                await springai.printAnswerText(response.body, uuid);

            } catch (error) {
                console.error("Fatal Error in handleSubmit:", error);
                const lastMessage = document.getElementById('chatPanel').lastChild.querySelector('.message-content');
                if (lastMessage) {
                    lastMessage.textContent += `\n\n[í†µì‹  ì˜¤ë¥˜: ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.]`;
                }
            } finally {
                //ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê¸°
                springai.setSpinner("spinner", false);
                questionInput.value = ""; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
                questionInput.focus(); // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
            }
        } 
        
        // Enter í‚¤ ì²˜ë¦¬
        window.onload = function() {
            document.getElementById("question").addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault(); // ê¸°ë³¸ Enter ë™ì‘(í¼ ì œì¶œ) ë°©ì§€
                    handleSubmit();
                }
            });
        };
    </script>
</head>

<body>
    <div class="d-flex flex-column vh-100">
        <!-- ìƒë‹¨ í—¤ë” íŒ¨ë„ -->
        <div id="headPanel" class="navbar justify-content-between p-3">
            <a href="/" class="navbar-brand ps-2 fw-bold d-flex align-items-center" style="color: #4285F4;">
                <!-- ë¡œê³  ì´ë¯¸ì§€ë¥¼ í…ìŠ¤íŠ¸ì™€ ì•„ì´ì½˜ìœ¼ë¡œ ëŒ€ì²´ -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"></path><path d="M12 7v5l3 3"></path></svg>
                Spring AI + Gemini Chat
            </a>
            <div id="spinner" class="spinner-border text-success d-none me-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>

        <!-- ëŒ€í™” íŒ¨ë„ -->
        <div id="chatPanel" class="flex-grow-1 container-fluid h-100 my-2" style="overflow-y:auto; overflow-x:hidden; padding-top: 10px;">
            <!-- ì´ˆê¸° ë©”ì‹œì§€ -->
            <div class="d-flex justify-content-start p-2">
                <div class="assistant-message" style="border-radius: 18px;">
                    <span class="fw-bold text-success">ğŸ¤– Gemini: </span>
                    <span class="message-content">ì§ˆë¬¸ì„ ì˜¬ë ¤ì£¼ì„¸ìš”. ì €ëŠ” ENTPì²˜ëŸ¼ ë‹µë³€í•˜ë„ë¡ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
                </div>
            </div>
        </div>

        <!-- ì…ë ¥ íŒ¨ë„ -->
        <div id="inputPanel" class="bg-white border-top">
            <div class="input-group p-3">
                <span class="input-group-text bg-primary text-white" style="font-weight: 500;">ì§ˆë¬¸</span>
                <input id="question" type="text" class="form-control" placeholder="ì—¬ê¸°ì— ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." value="">
                <button type="button" class="btn btn-primary" onclick="handleSubmit()">ì œì¶œ</button>
            </div>
        </div>
    </div>
</body>

</html>
